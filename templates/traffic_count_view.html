{% extends 'base.html' %}
{% block title %}Traffic Counter{% endblock %}
{% block content %}

<div class="container my-5 content-wrapper">
    <h1 class="text-center mb-4">LAPORAN TRAFFIC COUNT</h1>
    <div id="charts-container" class="row">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Memuat data grafik...</span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let charts = {};

    function updateSummary() {
        fetch('/api/summary/all_active')
            .then(response => response.json())
            .then(data => {
                const chartsContainer = document.getElementById('charts-container');

                const sortedCctvIds = Object.keys(data).sort((a, b) => data[a].nama.localeCompare(data[b].nama));

                if (Object.keys(charts).length === 0) {
                    chartsContainer.innerHTML = '';
                }

                for (const cctvId of sortedCctvIds) {
                    const cctvData = data[cctvId];
                    let chartCanvas = document.getElementById(`chart-${cctvId}`);

                    if (!chartCanvas) {
                        const chartWrapper = document.createElement('div');
                        chartWrapper.className = 'col-12 mb-4';
                        chartWrapper.innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h5>${cctvData.nama}</h5>
                                    
                                    <div class="custom-legend">
                                        <span class="legend-item">
                                            <span class="legend-color-box" style="background-color: rgba(0, 153, 153, 1);"></span>
                                            ${cctvData.label_normal}
                                        </span>
                                        <span class="legend-item">
                                            <span class="legend-color-box" style="background-color: rgba(255, 102, 102, 1 );"></span>
                                            ${cctvData.label_opposite}
                                        </span>
                                    </div>

                                </div>
                                <div class="card-body">
                                    <div style="height: 300px;"> 
                                        <canvas id="chart-${cctvId}"></canvas>
                                    </div>
                                </div>
                            </div>
                        `;
                        chartsContainer.appendChild(chartWrapper);
                        chartCanvas = document.getElementById(`chart-${cctvId}`);
                    }

                    const labels = [
                        'Sepeda Motor', 'Minibus, R4 Pribadi/elf', 'Kendaraan Berat', 'Bus Besar', 'Truk Besar'
                    ];
                    const normalData = cctvData.normal.cumulative || {};
                    const oppositeData = cctvData.opposite.cumulative || {};

                    const chartData = {
                        labels: labels,
                        datasets: [
                            {
                                label: cctvData.label_normal || 'Arah Normal',
                                data: [
                                    normalData.kelas_1_sepeda_motor || 0,
                                    normalData.kelas_2_minibus_r4_pribadi_atau_elf || 0,
                                    normalData.kelas_3_kendaraan_berat || 0,
                                    normalData.kelas_4_bus_besar || 0,
                                    normalData.kelas_5_truk_besar || 0
                                ],
                                backgroundColor: 'rgba(0, 153, 153, 1)',
                                borderColor: 'rgba(0, 153, 153, 1)',
                                borderWidth: 1,
                                borderRadius: 2
                            },
                            {
                                label: cctvData.label_opposite || 'Arah Opposite',
                                data: [
                                    oppositeData.kelas_1_sepeda_motor || 0,
                                    oppositeData.kelas_2_minibus_r4_pribadi_atau_elf || 0,
                                    oppositeData.kelas_3_kendaraan_berat || 0,
                                    oppositeData.kelas_4_bus_besar || 0,
                                    oppositeData.kelas_5_truk_besar || 0
                                ],
                                backgroundColor: 'rgba(255, 102, 102, 1)',
                                borderColor: 'rgba(255, 102, 102, 1)',
                                borderWidth: 1,
                                borderRadius: 2
                            }
                        ]
                    };

                    if (charts[cctvId]) {
                        charts[cctvId].data = chartData;
                        charts[cctvId].update();
                    } else {
                        const ctx = chartCanvas.getContext('2d');
                        charts[cctvId] = new Chart(ctx, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        grid: {
                                            display: false
                                        },
                                    },
                                    y: {
                                        beginAtZero: true,
                                        max: 5000,
                                        ticks: {
                                            stepSize: 1000
                                        },
                                        title: {
                                            display: true,
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false,
                                    }
                                }
                            }
                        });
                    }
                }
            })
            .catch(err => {
                console.error('Error fetching summary:', err);
            });
    }

    setInterval(updateSummary, 10000);
    document.addEventListener('DOMContentLoaded', updateSummary);
</script>
{% endblock %}